<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>German Vocab Trainer</title>
  <style>
    :root{
      --bg:#0f1115; --text:#eaeaea; --muted:#9aa6b2; --card:#171b23; --border:#2a3240; --input:#0f1620;
      --btn:#243042; --btn-hover:#2a3a50; --ok:#22c55e; --bad:#f97373;
      --der:#7fb3ff; --der-text:#0b2139; --die:#ff9aa2; --die-text:#3a0b12; --das:#9be7a1; --das-text:#0d2a14;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;padding:10px;background:var(--bg);color:var(--text)}
    .container{max-width:500px;margin:auto;padding:10px}
    h1{font-size:1.8em;text-align:center;margin-bottom:10px}
    #level{text-align:center;margin-bottom:15px;font-size:1.1em;color:var(--muted)}
    .card{background:var(--card);border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,.35);border:1px solid var(--border)}

    .button-row{display:flex;gap:8px}
    .article-btn{flex:1 1 0;padding:12px 0;font-size:16px;border-radius:10px;cursor:pointer;border:1px solid var(--border);background:#202734;color:var(--text)}
    #btnDer.selected{background:var(--der);color:var(--der-text);border-color:#6aa6ff}
    #btnDie.selected{background:var(--die);color:var(--die-text);border-color:#ff8a93}
    #btnDas.selected{background:var(--das);color:var(--das-text);border-color:#86d892}

    input{width:48%;padding:12px;margin:5px 1%;font-size:16px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text)}
    input::placeholder{color:#7b879a}
    input:focus{outline:2px solid #3b82f680;border-color:#3b82f6}

    button{padding:12px;margin:5px 1%;font-size:16px;border-radius:8px;border:1px solid var(--border);background:var(--btn);color:var(--text);cursor:pointer}
    button:hover{background:var(--btn-hover)}

    #feedback{margin-top:5px;font-size:1em}
    #example{margin-top:6px;font-size:.95em;color:var(--muted)}
    #nextBtn{display:none;width:100%}
    #status{margin-top:10px;font-size:.9em;color:var(--muted);white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">
    <h1>German Vocab Trainer</h1>
    <p id="level">Level: 1 (Words 1â€“25)</p>

    <div class="card">
      <!-- English ABOVE image -->
      <p id="englishRow"><strong>English word:</strong> <span id="english"></span> <em id="streakDisplay"></em></p>

      <!-- Image -->
      <div id="media" style="margin-bottom:8px;">
        <img id="wordImage" alt="vocab image" style="display:none;width:100%;max-height:220px;object-fit:contain;background:#0d0f14;border:1px solid var(--border);border-radius:10px;padding:8px;" />
      </div>

      <div class="button-row">
        <button id="btnDer" class="article-btn" onclick="chooseArticle('der')">der</button>
        <button id="btnDie" class="article-btn" onclick="chooseArticle('die')">die</button>
        <button id="btnDas" class="article-btn" onclick="chooseArticle('das')">das</button>
      </div>

      <input type="text" id="german" placeholder="German word" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      <input type="text" id="plural" placeholder="Plural" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      <p id="feedback"></p>
      <p id="example"></p>

      <br />
      <button onclick="checkAnswer()">Check</button>
      <button id="resetBtn" onclick="resetProgress()">Reset Progress</button>
      <button id="nextBtn" onclick="nextWord()">Next word</button>
      <div id="status"></div>
    </div>
  </div>

  <!-- Toggle under frame -->
  <label style="display:flex;align-items:center;gap:8px;margin:10px auto 0;max-width:500px;color:var(--muted);font-size:.95em;">
    <input type="checkbox" id="toggleEnglish" checked /> Show English word
  </label>

  <script>
    // ===== State =====
    let words = [];
    let currentWord = null;
    let chosenArticle = '';
    let level = 1;
    const wordsPerLevel = 25;
    const masteryThreshold = 3;
    let pluralEnterCount = 0;
    let lastFocusId = 'german'; // keep keyboard up on mobile

    const statusEl = document.getElementById('status');
    const englishRowEl = document.getElementById('englishRow');

    function status(msg){ if(statusEl) statusEl.textContent = msg; }

    // ===== CSV Parser (robust newlines; DO NOT change '
'/'
') =====
    function parseCSV(text){
      const rows=[]; let row=[]; let cur=''; let inQuotes=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c==='"'){
          if(inQuotes && text[i+1]==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; }
        } else if(c===',' && !inQuotes){
          row.push(cur); cur='';
        } else if((c==='
' || c==='
') && !inQuotes){
          if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        } else {
          cur+=c;
        }
      }
      if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    // ===== Data loading =====
    async function loadCSV(){
      try{
        const res = await fetch('vocab.csv', {cache:'no-store'});
        if(!res.ok) throw new Error('Failed to load vocab.csv');
        const data = await res.text();
        const lines = parseCSV(data.trim());
        if(lines.length===0){ status('vocab.csv is empty'); return; }
        lines.shift();
        words = lines.map(cols=>{
          const english=cols[0]||''; const article=cols[1]||''; const german=cols[2]||''; const plural=cols[3]||'';
          const ex1=cols[4]||''; const ex2=cols[5]||''; const ex3=cols[6]||'';
          const examples=[ex1,ex2,ex3].filter(x=>x&&x.trim()!=='');
          return { english, article, german, plural, examples, correctStreak:0, answeredCorrect:false };
        });
        loadProgress();
        updateLevelDisplay();
        nextWord();
        status('');
      }catch(e){ console.error(e); status('Error: '+e.message); }
    }

    function updateLevelDisplay(){
      document.getElementById('level').textContent = `Level: ${level} (Words 1â€“${level*wordsPerLevel})`;
    }

    function getActiveWords(){ return words.slice(0, level*wordsPerLevel); }

    function getTierWords(){
      const active=getActiveWords(); if(active.length===0) return [];
      const minStreak=Math.min(...active.map(w=>w.correctStreak));
      return active.filter(w=>w.correctStreak===minStreak && !w.answeredCorrect);
    }

    function nextWord(){
      const activeWords=getActiveWords(); if(activeWords.length===0) return;
      let tierWords=getTierWords();
      if(tierWords.length===0){
        const minStreak=Math.min(...activeWords.map(w=>w.correctStreak));
        activeWords.filter(w=>w.correctStreak===minStreak).forEach(w=>w.answeredCorrect=false);
        tierWords=getTierWords();
      }
      const list=(tierWords.length?tierWords:activeWords);
      currentWord=list[Math.floor(Math.random()*list.length)];

      document.getElementById('english').textContent=currentWord.english;
      document.getElementById('streakDisplay').textContent=`(${currentWord.correctStreak}/${masteryThreshold})`;
      document.getElementById('german').value='';
      document.getElementById('plural').value='';
      document.getElementById('feedback').textContent='';
      document.getElementById('example').textContent='';
      document.getElementById('nextBtn').style.display='none';
      chosenArticle='';
      resetArticleButtons();
      pluralEnterCount=0;

      loadImageForCurrent();
      applyEnglishVisibility();

      document.getElementById('german').focus();
    }

    function resetArticleButtons(){
      document.getElementById('btnDer').classList.remove('selected');
      document.getElementById('btnDie').classList.remove('selected');
      document.getElementById('btnDas').classList.remove('selected');
    }

    function chooseArticle(article){
      chosenArticle=article; resetArticleButtons();
      if(article==='der') document.getElementById('btnDer').classList.add('selected');
      if(article==='die') document.getElementById('btnDie').classList.add('selected');
      if(article==='das') document.getElementById('btnDas').classList.add('selected');
      // Always shift focus to the German field to keep keyboard up
      const germanEl=document.getElementById('german');
      if(germanEl){ lastFocusId='german'; setTimeout(()=>{ germanEl.focus(); },0); }
    }

    function randomExample(examples){ if(!examples||examples.length===0) return ''; const i=Math.floor(Math.random()*examples.length); return examples[i]; }

    function checkAnswer(){
      if(!currentWord) return;
      const german=document.getElementById('german').value.trim().toLowerCase();
      const plural=document.getElementById('plural').value.trim().toLowerCase();
      let feedback='';
      const correctGerman=(currentWord.german||'').toLowerCase();
      const correctPlural=(currentWord.plural||'').toLowerCase();
      const pluralCorrect=(plural===correctPlural) || (correctPlural==='â€”' && plural==='');
      if(chosenArticle===currentWord.article && german===correctGerman && pluralCorrect){
        currentWord.correctStreak++; currentWord.answeredCorrect=true; feedback='<span style="color:var(--ok)">Correct!</span>';
      } else {
        currentWord.correctStreak=0; currentWord.answeredCorrect=false; feedback=`<span style=\"color:var(--bad)\">Wrong!</span><br>Correct: ${currentWord.article} ${currentWord.german} â€” ${currentWord.plural}`;
      }
      document.getElementById('feedback').innerHTML=feedback;
      document.getElementById('streakDisplay').textContent=`(${currentWord.correctStreak}/${masteryThreshold})`;
      const ex=randomExample(currentWord.examples); document.getElementById('example').textContent=ex?`ðŸ“ ${ex}`:'';
      document.getElementById('nextBtn').style.display='inline-block';
      saveProgress();

      const activeWords=getActiveWords();
      const allMastered=activeWords.every(w=>w.correctStreak>=masteryThreshold);
      if(allMastered && level*wordsPerLevel<words.length){
        level++; activeWords.forEach(w=>{w.correctStreak=0; w.answeredCorrect=false;}); updateLevelDisplay(); saveProgress();
      }
    }

    function saveProgress(){
      try{ localStorage.setItem('vocabProgress', JSON.stringify({ words, level, showEnglish: document.getElementById('toggleEnglish').checked })); }catch{}
    }

    function loadProgress(){
      try{
        const saved=localStorage.getItem('vocabProgress');
        const cb=document.getElementById('toggleEnglish');
        if(saved){
          const data=JSON.parse(saved);
          level=data.level||1;
          if(cb) cb.checked = (data.showEnglish!==undefined)? !!data.showEnglish : true;
          words.forEach((w,i)=>{ if(data.words && data.words[i]){ w.correctStreak=data.words[i].correctStreak||0; w.answeredCorrect=data.words[i].answeredCorrect||false; } });
        } else { if(cb) cb.checked = true; }
      }catch{}
    }

    function resetProgress(){
      if(confirm('Are you sure you want to reset progress?')){
        try{ localStorage.removeItem('vocabProgress'); }catch{}
        words.forEach(w=>{ w.correctStreak=0; w.answeredCorrect=false; }); level=1; updateLevelDisplay(); nextWord();
      }
    }

    // Track focus + Enter behavior
    document.getElementById('german').addEventListener('focus', ()=>{ lastFocusId='german'; });
    document.getElementById('plural').addEventListener('focus', ()=>{ lastFocusId='plural'; });

    document.getElementById('german').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('plural').focus(); }});
    document.getElementById('plural').addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        pluralEnterCount++;
        if(pluralEnterCount===1) checkAnswer();
        else if(pluralEnterCount===2){ pluralEnterCount=0; nextWord(); }
      }
    });

    // Image helpers
    function replaceUmlauts(s){
      return (s||'')
        .replaceAll('Ã¤','ae').replaceAll('Ã„','Ae')
        .replaceAll('Ã¶','oe').replaceAll('Ã–','Oe')
        .replaceAll('Ã¼','ue').replaceAll('Ãœ','Ue')
        .replaceAll('ÃŸ','ss');
    }
    function buildCandidates(german){
      const baseRaw=(german||'').trim(); const bases=[];
      if(baseRaw){
        bases.push(baseRaw, baseRaw.toLowerCase(), baseRaw.replaceAll(' ','-'), baseRaw.toLowerCase().replaceAll(' ','-'));
        const uml=replaceUmlauts(baseRaw);
        bases.push(uml, uml.toLowerCase(), uml.replaceAll(' ','-'), uml.toLowerCase().replaceAll(' ','-'));
      }
      const exts=['jpg','jpeg','png','webp']; const out=[];
      bases.forEach(b=>exts.forEach(ext=>out.push('img/'+encodeURIComponent(b)+'.'+ext)));
      return out;
    }
    function loadImageForCurrent(){
      const img=document.getElementById('wordImage'); img.style.display='none';
      if(!currentWord||!currentWord.german){ img.removeAttribute('src'); return; }
      const candidates=buildCandidates(currentWord.german); let i=0;
      function tryNext(){
        if(i>=candidates.length){ img.removeAttribute('src'); img.style.display='none'; return; }
        const src=candidates[i++]; img.onerror=tryNext; img.onload=()=>{ img.style.display='block'; }; img.src=src+'?v='+Date.now();
      }
      tryNext();
    }

    // English toggle
    function applyEnglishVisibility(){
      const cb=document.getElementById('toggleEnglish');
      if(!englishRowEl) return;
      englishRowEl.style.display = cb && cb.checked ? '' : 'none';
    }
    document.getElementById('toggleEnglish').addEventListener('change', ()=>{ applyEnglishVisibility(); saveProgress(); });

    // Expose for inline handlers
    window.chooseArticle=chooseArticle;
    window.checkAnswer=checkAnswer;
    window.resetProgress=resetProgress;
    window.nextWord=nextWord;

    // Keep focus in the German field when tapping article buttons (iOS-safe)
    function initArticleButtonsFocusHack(){
      const ids = [ ['btnDer','der'], ['btnDie','die'], ['btnDas','das'] ];
      ids.forEach(([id, art])=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.setAttribute('tabindex','-1');
        const handler = (e)=>{
          try { e.preventDefault(); } catch {}
          const g = document.getElementById('german');
          if (g) {
            lastFocusId = 'german';
            // Try to grab focus immediately inside the user gesture
            try { g.focus({ preventScroll:true }); } catch { try { g.focus(); } catch {} }
            try { const L = g.value.length; g.setSelectionRange(L, L); } catch {}
          }
          chooseArticle(art);
          // Reinforce focus on next frames (iOS can drop it)
          requestAnimationFrame(()=>{
            if (g) { try { g.focus({ preventScroll:true }); } catch { try { g.focus(); } catch {} } }
          });
          setTimeout(()=>{
            if (g) { try { g.focus({ preventScroll:true }); } catch { try { g.focus(); } catch {} } }
          }, 60);
        };
        ['touchstart','pointerdown','mousedown'].forEach(evt=>{
          el.addEventListener(evt, handler, { passive:false });
        });
        el.addEventListener('click', handler);
      });
    }

    // initialize the focus hack immediately (elements already exist)
    initArticleButtonsFocusHack();

    // Start
    loadCSV();
  </script>
</body>
</html>
