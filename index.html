<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>German Trainer</title>

<!-- JSZip for Kapitel package loading -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- Firebase (optional username-only sync; safe if unused) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0b0e12; --card:#12161d; --text:#e9eef5; --muted:#9aacbf; --border:#243041; --accent:#6aa6ff;
    --good:#22c55e; --bad:#ef4444; --btn:#1a2230; --btn2:#1e2a3c; --hole:#0f141c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;}
  html{-webkit-text-size-adjust:100%}
  body{touch-action:manipulation}
  a{color:var(--accent)}
  .wrap{max-width:720px;margin:0 auto;padding:14px}
  .bar{display:flex;gap:8px;align-items:center;margin:6px auto 10px;max-width:720px}
  .bar select,.bar button{background:var(--btn);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .bar button:hover{background:var(--btn2)}
  .mode-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 12px}
  .mode-btn{border:1px solid var(--border);background:var(--btn);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .mode-btn.active{outline:2px solid var(--accent);background:#0f1420}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:8px 0}
  input[type="text"],input[type="search"],input[type="number"],select,textarea{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--hole);color:var(--text);
    font-size:16px; /* prevent iOS zoom */
}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;margin-top:10px}
  .actions button{background:var(--btn);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);cursor:pointer}
  .actions button:hover{background:var(--btn2)}
  .hole{display:inline-block;min-width:64px;padding:6px 8px;border:1px dashed var(--border);border-radius:8px;background:#0b1017}
  .center{display:flex;justify-content:center;align-items:center}
  .hidden{display:none !important}
  .label{opacity:.9}

  /* Kapitel Mix modern screen */
  .kmx{display:grid;gap:10px}
  .kmx .big-card{padding:18px;border-radius:16px}
  .kmx .title{font-weight:700;font-size:18px}
  .kmx .sub{color:var(--muted);font-size:13px}
  .kmx .quiet{opacity:.85}
  .kmx .badge{border:1px solid var(--accent);color:var(--accent);padding:2px 8px;border-radius:999px;font-size:12px}

  /* Debug HUD */
  /* Sidebar helpers */
  .side-open #side{ transform:translateX(0) }
  .side-open #sideMask{ display:block }
  #debugHUD{position:fixed;right:8px;bottom:8px;background:#0b111a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:#b7c6d8;font-size:12px;min-width:220px;z-index:9999;display:none}
  #debugHUD code{font-size:12px}
  #debugHUD .row{grid-template-columns:100px 1fr}

  /* Simple helper for article buttons */
  .article-bar{display:flex;gap:8px;margin:8px 0}
  .article-btn{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--btn);color:var(--text);padding:10px 12px}
  .article-btn.active{outline:2px solid var(--accent)}

  /* Splash modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10000}
  .modal .box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:520px;width:92%}
</style>
</head>
<body>

<div class="wrap">
  <!-- Header + Sidebar trigger -->
	<div class="bar" style="justify-content:space-between;">
	  <div style="display:flex;align-items:center;gap:10px">
		<button id="btnSide" class="mode-btn" style="padding:8px 10px">â˜°</button>
		<strong>German Trainer</strong>
	  </div>
	  <span id="datasetCtx" class="muted small"></span>
	</div>

	<!-- Slide-out Sidebar -->
	<aside id="side" style="position:fixed;inset:0 0 0 auto; width:300px; max-width:85%; background:var(--card); border-left:1px solid var(--border); box-shadow:-18px 0 30px rgba(0,0,0,.35); transform:translateX(100%); transition:transform .22s ease; z-index:20000; padding:14px; display:flex; flex-direction:column; gap:12px">
	  <div style="display:flex;justify-content:space-between;align-items:center">
		<strong>Settings</strong>
		<button id="btnSideClose" class="mode-btn" style="padding:6px 10px">âœ•</button>
	  </div>

	  <div class="card" style="padding:12px">
		<div class="small muted" style="margin-bottom:6px">Dataset</div>
		<select id="datasetSel" title="Dataset" style="width:100%">
		  <option value="default">Default</option>
		</select>
		<button id="btnLoadKapitel" style="width:100%; margin-top:8px">Load Kapitelâ€¦</button>
	  </div>

	  <div class="card" style="padding:12px">
		<div class="small muted" style="margin-bottom:6px">Cloud</div>
		<button id="btnSync" title="Cloud Sync" style="width:100%">Sync</button>
		<div id="syncStatus" class="muted small" style="margin-top:6px">Sync: Off</div>
	  </div>

	  <div class="card" style="padding:12px">
		<div class="small muted" style="margin-bottom:6px">Debug</div>
		<button id="btnDebug" style="width:100%">Debug HUD</button>
	  </div>
	</aside>
	<div id="sideMask" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:19000;display:none"></div>


  <div class="mode-tabs" id="modeTabs">
    <button class="mode-btn" data-mode="vocab">Vocab</button>
    <button class="mode-btn" data-mode="verbs">Verbs</button>
    <button class="mode-btn" data-mode="adjadv">Adj/Adv</button>
    <button class="mode-btn" data-mode="preps">Preps</button>
    <button class="mode-btn" data-mode="mix">Mix</button>
    <button class="mode-btn" data-mode="kapitelMix" id="btnKapitelMix" disabled>Kapitel Mix</button>
  </div>

  <!-- ====== VOCAB ====== -->
  <section id="vocab" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div><strong id="vocabEn" class="muted"></strong> <span id="vocabStreak" class="pill"></span></div>
      <div id="vocabLevel" class="pill"></div>
    </div>

    <div class="article-bar">
      <button class="article-btn" data-a="der">der</button>
      <button class="article-btn" data-a="die">die</button>
      <button class="article-btn" data-a="das">das</button>
    </div>

    <div class="row"><div class="label">German</div><div><input id="vocabDe" type="text" autocomplete="off"></div></div>
    <div class="row"><div class="label">Plural</div><div><input id="vocabPl" type="text" autocomplete="off"></div></div>
    <div id="vocabExamples" class="muted small"></div>

    <div id="vocabFeedback" class="small" style="margin-top:8px"></div>
    <div class="actions">
      <button id="vocabCheck">Check</button>
      <button id="vocabNext">Next</button>
      <button id="vocabReset" class="muted">Reset</button>
      <label class="muted small" style="margin-left:auto;display:flex;align-items:center;gap:6px"><input id="vocabShowEn" type="checkbox" checked>show English</label>
    </div>
  </section>

  <!-- ====== VERBS ====== -->
  <section id="verbs" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div><strong id="verbEn" class="muted"></strong> <span id="verbsLevel" class="pill"></span></div>
      <div class="pill">Streak target: 3</div>
    </div>

    <div class="row"><div class="label">Infinitive</div><div><input id="vInf" type="text" autocomplete="off"></div></div>

    <div class="row"><div class="label">Aux</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="article-btn" data-aux="haben">haben</button>
        <button class="article-btn" data-aux="sein">sein</button>
        <button class="article-btn" data-aux="haben/sein">haben/sein</button>
        <span id="auxHint" class="pill"></span>
      </div>
    </div>

    <div class="row"><div class="label">ich</div><div><input id="pIch" type="text"></div></div>
    <div class="row"><div class="label">du</div><div><input id="pDu" type="text"></div></div>
    <div class="row"><div class="label">er/sie/es</div><div><input id="pEr" type="text"></div></div>
    <div class="row"><div class="label">ihr</div><div><input id="pIhr" type="text"></div></div>

    <div class="row"><div class="label">PrÃ¤teritum</div><div><input id="vPast" type="text" placeholder="z. B. ging"></div></div>
    <div class="row"><div class="label">Partizip II</div><div><input id="vPart" type="text" placeholder="z. B. gegangen"></div></div>

    <div class="row"><div class="label">Preposition(s)</div><div><input id="vPrep" type="text" placeholder="auf;Ã¼ber;mit (optional)"></div></div>
    <div class="row"><div class="label">Case</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="article-btn" data-case="inf">inf</button>
        <button class="article-btn" data-case="akk">akk</button>
        <button class="article-btn" data-case="dat">dat</button>
        <span id="caseHint" class="pill"></span>
      </div>
    </div>
    <div class="row"><div class="label">Reflexive</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="article-btn" data-refl="true">true</button>
        <button class="article-btn" data-refl="false">false</button>
      </div>
    </div>

    <div id="verbsFeedback" class="small" style="margin-top:8px"></div>
    <div class="actions">
      <button id="verbsCheck">Check</button>
      <button id="verbsNext">Next</button>
      <button id="verbsReset" class="muted">Reset</button>
    </div>
  </section>

  <!-- ====== ADJ/ADV ====== -->
  <section id="adjadv" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div><strong id="aaEn" class="muted"></strong> <span id="aaLevel" class="pill"></span></div>
      <div class="pill">Streak target: 3</div>
    </div>
    <p id="aaExample" class="muted small"></p>
    <div class="row"><div class="label">German</div><div><input id="aaDe" type="text" autocomplete="off"></div></div>
    <div id="aaFeedback" class="small" style="margin-top:8px"></div>
    <div class="actions">
      <button id="aaCheck">Check</button>
      <button id="aaNext">Next</button>
      <button id="aaReset" class="muted">Reset</button>
    </div>
  </section>

  <!-- ====== PREPOSITIONS (cloze) ====== -->
  <section id="preps" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div><strong id="ppHeader" class="muted">Fill the blank with exact surface form</strong> <span id="ppLevel" class="pill"></span></div>
      <div class="pill">Streak target: 3</div>
    </div>
    <p id="ppSentence" style="font-size:18px;line-height:1.6"></p>
    <p id="ppEnglish" class="muted small"></p>
    <div class="actions">
      <button id="ppCheck">Check</button>
      <button id="ppNext">Next</button>
      <button id="ppReset" class="muted">Reset</button>
    </div>
    <div id="ppFeedback" class="small" style="margin-top:8px"></div>
  </section>

  <!-- ====== DEFAULT MIX (round-robin, level-gated) ====== -->
  <section id="mix" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Mix</strong> <span class="muted small">round-robin â€¢ prefers streak&lt;3 â€¢ respects levels</span></div>
      <div class="pill" id="mixInfo"></div>
    </div>
    <div id="mixMount" style="margin-top:8px"></div>
    <div class="small muted" style="margin-top:8px">Tip: press Enter to check; Enter again to advance.</div>
  </section>

  <!-- ====== KAPITEL MIX (separate UI) ====== -->
  <section id="kapitelMix" class="card hidden">
    <div class="kmx">
      <div class="big-card">
        <div class="title">Kapitel Mix</div>
        <div class="sub" id="kmxCtx">Rotates across Vocab, Verbs, Adj/Adv, Preps â€¢ prefers unmastered â€¢ no levels.</div>
      </div>
      <div id="kmxMount"></div>
      <div class="actions">
        <button id="kmxNext">Next</button>
        <button id="kmxReset" class="muted">Reset Kapitel progress</button>
        <span id="kmxAllDone" class="badge hidden">Kapitel mastered ðŸŽ‰</span>
      </div>
    </div>
  </section>

  <div class="bar" style="margin-top:8px">
    <button id="btnSync" title="Cloud Sync">Sync</button>
    <span id="syncStatus" class="muted small">Sync: Off</span>
    <button id="btnDebug" style="margin-left:auto">Debug HUD</button>
  </div>
</div>

<!-- Debug HUD -->
<div id="debugHUD">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
    <strong>Debug</strong>
    <button id="dbgDump" class="mode-btn" style="padding:4px 8px">dump</button>
  </div>
  <div class="row"><div>dataset</div><div><code id="dbgDataset"></code></div></div>
  <div class="row"><div>mode</div><div><code id="dbgMode"></code></div></div>
  <div class="row"><div>sizes</div><div><code id="dbgSizes"></code></div></div>
  <div class="row"><div>last pick</div><div><code id="dbgPick"></code></div></div>
</div>

<!-- Simple Sync modal -->
<div id="syncModal" class="modal">
  <div class="box">
    <h3 style="margin:.2rem 0 .4rem">Cloud Sync (optional)</h3>
    <p class="muted small">Use a simple username to push/pull your local progress to Firebase Realtime DB.</p>
    <div class="row"><div class="label">Username</div><div><input id="syncUser" type="text" placeholder="e.g., negm"></div></div>
    <div class="actions" style="justify-content:flex-end">
      <button id="syncCancel">Cancel</button>
      <button id="syncEnable">Enable</button>
    </div>
  </div>
</div>

<script>
/* ===========================================================
   CLEAN CORE â€” ENV & UTIL
   =========================================================== */

/* ====== EDIT HOOKS (use these markers for future edits) ======
   FIND â†’ PASTE BELOW: FIREBASE_CONFIG
   FIND â†’ PASTE BELOW: SAMPLE_CSVS
   FIND â†’ PASTE BELOW: UI_COPY
   =========================================================== */

const APP = {
  dsKey: 'default',     // 'default' | 'kapitel'
  mode: 'vocab',        // 'vocab'|'verbs'|'adjadv'|'preps'|'mix'|'kapitelMix'
  masteryTarget: 3,
  wordsPerLevel: 25,
  debug: false,
  kapitel: { title: '', counts: {vocab:0,verbs:0,adjadv:0,preps:0}, files:null }, // when loaded
  rnd: (n)=>Math.floor(Math.random()*n),
  norm: (s)=> (s||'').trim().toLowerCase(),
  normDe: (s)=> (s||'').trim().toLowerCase().replaceAll('ÃŸ','ss').replaceAll('Ã¤','ae').replaceAll('Ã¶','oe').replaceAll('Ã¼','ue'),
  pick: (arr)=> arr.length? arr[Math.floor(Math.random()*arr.length)] : null
};

// LocalStorage helpers (namespaced by dataset)
const LS = {
  key: (k)=> `${k}::${APP.dsKey}`,
  get: (k, fb)=>{ try{ const v = localStorage.getItem(LS.key(k)); return v? JSON.parse(v): fb; }catch{ return fb; } },
  set: (k, v)=>{ try{ localStorage.setItem(LS.key(k), JSON.stringify(v)); }catch{}; scheduleSyncSoon(); },
  del: (k)=>{ try{ localStorage.removeItem(LS.key(k)); }catch{}; scheduleSyncSoon(); }
};

// CSV parsing
function parseCSV(text){
  const rows=[]; let row=[]; let cur=''; let q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){ if(q && text[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
    else if(c===',' && !q){ row.push(cur); cur=''; }
    else if((c==='\n'||c==='\r') && !q){ if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } }
    else { cur+=c; }
  }
  if(cur!==''||row.length){ row.push(cur); rows.push(row); }
  return rows;
}

// datasetRead: read from Kapitel package or fetch local file
async function datasetRead(name){
  // Prefer Kapitel files when Kapitel dataset is active
  if(APP.dsKey==='kapitel' && APP.kapitel.files && APP.kapitel.files[name]!=null){
    return APP.kapitel.files[name];
  }
  // If we have inline samples for Default, use them
  if(APP.dsKey==='default' && APP._inline && APP._inline[name]!=null){
    return APP._inline[name];
  }
  // Fallback: fetch local CSVs
  const res = await fetch(name, {cache:'no-store'});
  if(!res.ok) throw new Error('Failed to load ' + name);
  return await res.text();
}


// UI helpers
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
function show(id){ const el=$(id.startsWith('#')?id:`#${id}`); el&&el.classList.remove('hidden'); }
function hide(id){ const el=$(id.startsWith('#')?id:`#${id}`); el&&el.classList.add('hidden'); }
function setMode(m){ APP.mode=m; localStorage.setItem('mode', m); renderMode(); updateHUD(); }
// Mount trainer sections without cloning (preserves events)
const mixMounts = { mix:'#mixMount', kapitel:'#kmxMount' };
let mounted = null; // {sec, parentId}

function mountSection(sec, where){ // where: 'mix' | 'kapitel'
  const map = {vocab:'#vocab',verbs:'#verbs',adjadv:'#adjadv',preps:'#preps'};
  const sel = map[sec]; if(!sel) return;
  const el = document.querySelector(sel);
  if(!el) return;

  // unmount any previous
  if(mounted && mounted.sec){
    const oldEl = document.querySelector(map[mounted.sec]);
    if(oldEl){
      // return to root container (wrap)
      document.querySelector('.wrap').appendChild(oldEl);
      oldEl.classList.add('hidden');
    }
    mounted=null;
  }

  const host = document.querySelector(mixMounts[where]);
  host.innerHTML='';
  el.classList.remove('hidden');
  host.appendChild(el);
  mounted = { sec, parentId: mixMounts[where] };
}


// Debug HUD
function updateHUD(){
  $('#dbgDataset').textContent = APP.dsKey;
  $('#dbgMode').textContent = APP.mode;
  const sizes = {
    vocab: state.vocab.data.length,
    verbs: state.verbs.data.length,
    adjadv: state.adjadv.data.length,
    preps: state.preps.data.length
  };
  $('#dbgSizes').textContent = JSON.stringify(sizes);
}

// ===== Firebase (optional) =====
// FIND â†’ PASTE BELOW: FIREBASE_CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAvMyNtFyWM3Ajg2sxpWp4uMErfyawEOMc",
  authDomain: "german-52657.firebaseapp.com",
  databaseURL: "https://german-52657-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "german-52657",
  storageBucket: "german-52657.firebasestorage.app",
  messagingSenderId: "364706857329",
  appId: "1:364706857329:web:97779c21361db2423336d0"
};
try{ if(!window._fbApp) window._fbApp = firebase.initializeApp(firebaseConfig); }catch{}
const db = firebase.database();
const SYNC_KEYS = [
  'vocabProgress','verbsProgress','adjadvProgress','prepsProgress',
  'mixState','kapitel_current_v1'
];
const cloudPath = (u)=> 'users/'+encodeURIComponent(u);
async function cloudPull(u){ const snap = await db.ref(cloudPath(u)).get(); return snap.exists()? snap.val(): null; }
async function cloudPush(u, data){ await db.ref(cloudPath(u)).set(data); }
function snapshotAll(){
  const out={}; SYNC_KEYS.forEach(k=>{ out[k+'::default']=localStorage.getItem(k+'::default')??null; out[k+'::kapitel']=localStorage.getItem(k+'::kapitel')??null; });
  out._meta = { t:Date.now(), ds:APP.dsKey, title: APP.kapitel.title||'Default' }; return out;
}
function applyCloud(data){
  Object.entries(data||{}).forEach(([k,v])=>{
    if(k==='_meta') return;
    if(v!=null) localStorage.setItem(k,String(v));
  });
}
let _syncTimer=null,_syncBusy=false;
function scheduleSyncSoon(){ const u=localStorage.getItem('syncUser'); if(!u) return; clearTimeout(_syncTimer); _syncTimer=setTimeout(runSync,1200); }
async function runSync(){ if(_syncBusy) return; const u=localStorage.getItem('syncUser'); if(!u) return; _syncBusy=true; try{ await cloudPush(u,snapshotAll()); }catch{} _syncBusy=false; }
setInterval(()=>{ if(localStorage.getItem('syncUser')) runSync(); },15000);

/* ===========================================================
   DATASET LAYER
   - Default: fetch local CSVs
   - Kapitel: upload ZIP (manifest.json + 4 CSVs). Never touch local CSVs.
   =========================================================== */

const dsUI = {
  update(){
    const sel = $('#datasetSel');
    // Rebuild
    sel.innerHTML = `<option value="default">Default</option>` + (localStorage.getItem('kapitel_current_v1')? `<option value="kapitel">Kapitel</option>`:'');
    sel.value = APP.dsKey;
    // Context line
    $('#datasetCtx').textContent = (APP.dsKey==='kapitel')
      ? `Studying: ${APP.kapitel.title} â€¢ ${APP.kapitel.counts.vocab} vocab Â· ${APP.kapitel.counts.verbs} verbs Â· ${APP.kapitel.counts.adjadv} adj/adv Â· ${APP.kapitel.counts.preps} preps`
      : '';
    // Modes
    $('#btnKapitelMix').disabled = (APP.dsKey!=='kapitel');
    // Hide normal Mix + level badges when Kapitel active (we still allow seeing the tabs, but default Mix does nothing)
    if(APP.dsKey==='kapitel' && APP.mode==='mix') setMode('kapitelMix');
    $('#vocabLevel').classList.toggle('hidden', APP.dsKey==='kapitel');
    $('#verbsLevel').classList.toggle('hidden', APP.dsKey==='kapitel');
    $('#aaLevel').classList.toggle('hidden', APP.dsKey==='kapitel');
    $('#ppLevel').classList.toggle('hidden', APP.dsKey==='kapitel');
  }
};

async function handleKapitelZip(file){
  const zip = await JSZip.loadAsync(file);
  async function readByName(b){ const e = Object.values(zip.files).find(f=>!f.dir && f.name.toLowerCase().endsWith('/'+b.toLowerCase())) || Object.values(zip.files).find(f=>!f.dir && f.name.toLowerCase()===b.toLowerCase()); return e? await e.async('string'): null; }
  const manifestTxt = await readByName('manifest.json');
  const vocabTxt    = await readByName('vocab.csv');
  const verbsTxt    = await readByName('verbs.csv');
  const adjadvTxt   = await readByName('adjadv.csv');
  const prepsTxt    = await readByName('prepositions.csv');

  if(!vocabTxt && !verbsTxt && !adjadvTxt && !prepsTxt){ alert('ZIP missing required CSVs.'); return; }
  let manifest=null; try{ manifest = manifestTxt? JSON.parse(manifestTxt): null; }catch{}
  const title = (manifest?.title) || (manifest?.kapitel? ('Kapitel '+manifest.kapitel): file.name.replace(/\.zip$/i,''));
  const counts = {
    vocab: (vocabTxt? vocabTxt.trim().split(/\r?\n/).length-1:0) || 0,
    verbs: (verbsTxt? verbsTxt.trim().split(/\r?\n/).length-1:0) || 0,
    adjadv: (adjadvTxt? adjadvTxt.trim().split(/\r?\n/).length-1:0) || 0,
    preps: (prepsTxt? prepsTxt.trim().split(/\r?\n/).length-1:0) || 0
  };
  APP.kapitel = { title, counts, files: {
    'manifest.json': manifestTxt||'',
    'vocab.csv': vocabTxt||'',
    'verbs.csv': verbsTxt||'',
    'adjadv.csv': adjadvTxt||'',
    'prepositions.csv': prepsTxt||''
  }};
  localStorage.setItem('kapitel_current_v1', JSON.stringify(APP.kapitel));
  APP.dsKey = 'kapitel';
  dsUI.update();
  await loadAll(); // reload data from dataset layer
  setMode('kapitelMix');
}

// restore persisted Kapitel (if any)
(function(){
  const saved = localStorage.getItem('kapitel_current_v1');
  if(saved){
    try{
      const k = JSON.parse(saved);
      APP.kapitel = { title:k.title, counts:k.counts, files:k.files };
      APP.dsKey = 'kapitel';
    }catch{}
  } else {
    APP.dsKey = 'default';
  }
})();

/* ===========================================================
   PROGRESS STRUCT
   =========================================================== */
const state = {
  vocab: { data:[], level:1, streaks:{}, idx:0, showEn:true, article:'' },
  verbs: { data:[], level:1, streaks:{}, idx:0 },
  adjadv:{ data:[], level:1, streaks:{}, idx:0 },
  preps: { data:[], level:1, streaks:{}, idx:0, // holds blanked token for check
           currentBlank:'', currentAnswer:'' }
};

function saveAll(){
  LS.set('vocabProgress', state.vocab);
  LS.set('verbsProgress', state.verbs);
  LS.set('adjadvProgress', state.adjadv);
  LS.set('prepsProgress', state.preps);
}
function loadAllProgress(){
  const v = LS.get('vocabProgress', null); if(v) Object.assign(state.vocab,v);
  const vb= LS.get('verbsProgress', null); if(vb) Object.assign(state.verbs,vb);
  const aa= LS.get('adjadvProgress', null); if(aa) Object.assign(state.adjadv,aa);
  const pp= LS.get('prepsProgress', null); if(pp) Object.assign(state.preps,pp);
}

/* ===========================================================
   TRAINERS (each exposes: load(data), hasData(), hasUnmastered(), render(), next())
   =========================================================== */

/* ---------- VOCAB ---------- 
   CSV headers: english,article,german,plural,example1,example2,example3
*/
const Vocab = {
  async load(){
    const txt = await datasetRead('vocab.csv');
    const rows = parseCSV(txt.trim()); rows.shift();
    state.vocab.data = rows.map(r=>({
      english:r[0]||'', article:r[1]||'', german:r[2]||'', plural:r[3]||'',
      ex:[r[4]||'', r[5]||'', r[6]||''].filter(Boolean)
    }));
  },
  hasData(){ return state.vocab.data.length>0; },
  levelPool(){ if(APP.dsKey==='kapitel') return state.vocab.data; return state.vocab.data.slice(0, state.vocab.level*APP.wordsPerLevel); },
  hasUnmastered(){ const pool=this.levelPool(); return pool.some(x=> (state.vocab.streaks[x.german]||0) < APP.masteryTarget); },
  pick(){
    const pool = this.levelPool();
    const prefer = pool.filter(x=>(state.vocab.streaks[x.german]||0)<APP.masteryTarget);
    return (prefer.length? APP.pick(prefer): APP.pick(pool)) || null;
  },
  render(item){
    $('#vocabEn').textContent = state.vocab.showEn? item.english : '';
    $('#vocabStreak').textContent = `${state.vocab.streaks[item.german]||0}/${APP.masteryTarget}`;
    $('#vocabExamples').textContent = item.ex.length ? ('ðŸ“ '+ APP.pick(item.ex)) : '';
    $('#vocabFeedback').textContent = '';
    $('#vocabDe').value=''; $('#vocabPl').value=''; state.vocab.article='';
    // level badge
    $('#vocabLevel').textContent = (APP.dsKey==='kapitel')? '' : `Level ${state.vocab.level}`;
    // article buttons
    $all('.article-bar .article-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.a===state.vocab.article);
    });
    $('#vocabDe').focus();
  },
  check(item){
    const a = state.vocab.article;
    const de = APP.norm($('#vocabDe').value);
    const pl = APP.norm($('#vocabPl').value);
    const ok = (a===item.article) && (de===APP.norm(item.german)) && (pl===APP.norm(item.plural||''));
    if(ok){ state.vocab.streaks[item.german]=(state.vocab.streaks[item.german]||0)+1; $('#vocabFeedback').innerHTML = `<span class="good">Correct!</span>`; }
    else { state.vocab.streaks[item.german]=0; $('#vocabFeedback').innerHTML = `<span class="bad">Wrong.</span> Correct: <b>${item.article} ${item.german}</b> â€” ${item.plural||'â€”'}`; }
    saveAll();
    // auto level-up (default only)
    if(APP.dsKey==='default'){
      const pool = this.levelPool();
      if(pool.length && pool.every(x=>(state.vocab.streaks[x.german]||0)>=APP.masteryTarget) && state.vocab.level*APP.wordsPerLevel < state.vocab.data.length){
        state.vocab.level++; saveAll();
      }
    }
  }
};

/* ---------- VERBS ----------
   CSV headers: id,lemma,english,aux,ich,du,er,wir,ihr,sie,partizip,past,preps,case,reflexive
   aux = haben|sein|haben/sein ; preps="auf;an;mit" ; case=inf|akk|dat ; reflexive=true|false
   id optional â†’ derive from lemma+english
*/
const Verbs = {
  async load(){
    const txt = await datasetRead('verbs.csv');
    const rows = parseCSV(txt.trim()); rows.shift();
    state.verbs.data = rows.map(r=>{
      const o = {
        id: r[0] || `${(r[1]||'').trim()}__${(r[2]||'').trim()}`,
        lemma: r[1]||'', english:r[2]||'', aux:(r[3]||'').trim().toLowerCase(),
        ich:r[4]||'', du:r[5]||'', er:r[6]||'', wir:r[7]||'', ihr:r[8]||'', sie:r[9]||'',
        partizip:r[10]||'', past:r[11]||'',
        preps:(r[12]||'').split(';').map(s=>s.trim()).filter(Boolean),
        case:(r[13]||'').trim().toLowerCase(),
        reflexive:String(r[14]||'').trim().toLowerCase()
      };
      return o;
    });
  },
  hasData(){ return state.verbs.data.length>0; },
  levelPool(){ if(APP.dsKey==='kapitel') return state.verbs.data; const cut = state.verbs.level*APP.wordsPerLevel; return state.verbs.data.slice(0, cut); },
  hasUnmastered(){ const p=this.levelPool(); return p.some(v=> (state.verbs.streaks[v.id]||0) < APP.masteryTarget); },
  pick(){
    const p=this.levelPool(); const prefer=p.filter(v=>(state.verbs.streaks[v.id]||0)<APP.masteryTarget);
    return (prefer.length? APP.pick(prefer) : APP.pick(p)) || null;
  },
  render(v){
    $('#verbEn').textContent = v.english;
    $('#verbsFeedback').textContent='';
    // wipe inputs
    ['#vInf','#pIch','#pDu','#pEr','#pIhr','#vPast','#vPart','#vPrep'].forEach(s=>{ const el=$(s); if(el) el.value=''; });
    // reset toggles
    $all('[data-aux]').forEach(b=>b.classList.remove('active'));
    $all('[data-case]').forEach(b=>b.classList.remove('active'));
    $all('[data-refl]').forEach(b=>b.classList.remove('active'));
    $('#auxHint').textContent=''; $('#caseHint').textContent='';
    // show level
    $('#verbsLevel').textContent = (APP.dsKey==='kapitel')? '' : `Level ${state.verbs.level}`;
    $('#vInf').focus();
  },
  check(v){
    let ok=true, msg=[];
    const mustEqual = (a,b,label, norm=APP.normDe)=>{
      const pass = norm(a)===norm(b);
      if(!pass){ ok=false; msg.push(`${label} âžœ <b>${b}</b>`); }
    };
    mustEqual($('#vInf').value, v.lemma, 'infinitive');
    // aux
    const chosenAux = $all('[data-aux].active')[0]?.dataset.aux || '';
    if(v.aux){ const allow = v.aux.split('/').map(s=>s.trim()); if(!allow.includes(chosenAux)){ ok=false; msg.push('aux âžœ <b>'+v.aux+'</b>'); } }
    // PrÃ¤sens (ich/du/er/ihr)
    mustEqual($('#pIch').value, v.ich, 'ich');
    mustEqual($('#pDu').value,  v.du,  'du');
    mustEqual($('#pEr').value,  v.er,  'er/sie/es');
    mustEqual($('#pIhr').value, v.ihr, 'ihr');
    // past / partizip
    mustEqual($('#vPast').value, v.past, 'PrÃ¤teritum');
    mustEqual($('#vPart').value, v.partizip, 'Partizip');
    // optional preps
    const givenPrep = APP.norm($('#vPrep').value);
    if(v.preps?.length){
      if(!v.preps.map(APP.norm).includes(givenPrep)){ ok=false; msg.push('prep âžœ <b>'+v.preps.join('; ')+'</b>'); }
    }
    // case
    const chosenCase = $all('[data-case].active')[0]?.dataset.case || '';
    if(v.case){ if(APP.norm(v.case)!==APP.norm(chosenCase)){ ok=false; msg.push('case âžœ <b>'+v.case+'</b>'); } }
    // reflexive
    const chosenRefl = $all('[data-refl].active')[0]?.dataset.refl || '';
    if(v.reflexive){ if(APP.norm(v.reflexive)!==APP.norm(chosenRefl)){ ok=false; msg.push('reflexive âžœ <b>'+v.reflexive+'</b>'); } }

    if(ok){ state.verbs.streaks[v.id]=(state.verbs.streaks[v.id]||0)+1; $('#verbsFeedback').innerHTML = `<span class="good">Correct!</span>`; }
    else { state.verbs.streaks[v.id]=0; $('#verbsFeedback').innerHTML = `<span class="bad">Wrong.</span> ${msg.length? 'Correct: '+msg.join(', ') : ''}`; }
    saveAll();

    if(APP.dsKey==='default'){
      const pool=this.levelPool();
      if(pool.length && pool.every(x=>(state.verbs.streaks[x.id]||0)>=APP.masteryTarget) && state.verbs.level*APP.wordsPerLevel < state.verbs.data.length){
        state.verbs.level++; saveAll();
      }
    }
  }
};

/* ---------- ADJ/ADV ----------
   CSV headers: english,german,example
*/
const AdjAdv = {
  async load(){
    const txt = await datasetRead('adjadv.csv');
    const rows = parseCSV(txt.trim()); rows.shift();
    state.adjadv.data = rows.map(r=>({ english:r[0]||'', german:r[1]||'', example:r[2]||'' }));
  },
  hasData(){ return state.adjadv.data.length>0; },
  levelPool(){ if(APP.dsKey==='kapitel') return state.adjadv.data; return state.adjadv.data.slice(0, state.adjadv.level*APP.wordsPerLevel); },
  hasUnmastered(){ const p=this.levelPool(); return p.some(x=> (state.adjadv.streaks[x.german]||0)<APP.masteryTarget); },
  pick(){ const p=this.levelPool(); const pref=p.filter(x=>(state.adjadv.streaks[x.german]||0)<APP.masteryTarget); return (pref.length?APP.pick(pref):APP.pick(p))||null; },
  render(x){
    $('#aaEn').textContent = x.english;
    $('#aaExample').textContent = x.example ? ('ðŸ“ '+x.example) : '';
    $('#aaFeedback').textContent=''; $('#aaDe').value=''; $('#aaDe').focus();
    $('#aaLevel').textContent = (APP.dsKey==='kapitel')? '' : `Level ${state.adjadv.level}`;
  },
  check(x){
    const ok = APP.normDe($('#aaDe').value)===APP.normDe(x.german);
    if(ok){ state.adjadv.streaks[x.german]=(state.adjadv.streaks[x.german]||0)+1; $('#aaFeedback').innerHTML='<span class="good">Correct!</span>'; }
    else { state.adjadv.streaks[x.german]=0; $('#aaFeedback').innerHTML=`<span class="bad">Wrong.</span> Correct: <b>${x.german}</b>`; }
    saveAll();
    if(APP.dsKey==='default'){
      const p=this.levelPool();
      if(p.length && p.every(z=>(state.adjadv.streaks[z.german]||0)>=APP.masteryTarget) && state.adjadv.level*APP.wordsPerLevel<state.adjadv.data.length){
        state.adjadv.level++; saveAll();
      }
    }
  }
};

/* ---------- PREPOSITIONS (CLOZE) ----------
   CSV headers:
   prep,forms,de1,de2,de3,de4,de5,de6,de7,de8,de9,de10, en1,en2,en3,en4,en5,en6,en7,en8,en9,en10
   - forms: semicolon list (e.g., "in;im;ins")
   - we blank the FIRST whole-word match of ANY token from forms inside the chosen sentence.
   - Only the exact surface form is correct.
*/
const Preps = {
  async load(){
    const txt = await datasetRead('prepositions.csv');
    const rows = parseCSV(txt.trim()); rows.shift();
    state.preps.data = rows.map(r=>{
      return {
        prep:r[0]||'', forms:(r[1]||'').split(';').map(s=>s.trim()).filter(Boolean),
        de: r.slice(2,12).map(x=>x||''), // de1..de10
        en: r.slice(12,22).map(x=>x||'') // en1..en10
      };
    });
  },
  hasData(){ return state.preps.data.length>0; },
  levelPool(){ if(APP.dsKey==='kapitel') return state.preps.data; return state.preps.data.slice(0, state.preps.level*APP.wordsPerLevel); },
  hasUnmastered(){ const p=this.levelPool(); return p.some(x=> (state.preps.streaks[x.prep]||0)<APP.masteryTarget); },
  pick(){ const p=this.levelPool(); const pref=p.filter(x=>(state.preps.streaks[x.prep]||0)<APP.masteryTarget); return (pref.length?APP.pick(pref):APP.pick(p))||null; },
  _blankOneSentence(item){
    const idxs = item.de.map((s,i)=>({i,s})).filter(x=> (x.s||'').trim().length>0);
    if(!idxs.length) return null;
    const pick = APP.pick(idxs);
    // Build regex for whole-word tokens (simple boundaries)
    const tokens = item.forms.filter(Boolean).sort((a,b)=>b.length-a.length);
    for(const t of tokens){
      const re = new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`,'u');
      if(re.test(pick.s)){
        const hole = `<span class="hole" contenteditable="true" id="ppHole"></span>`;
        const sent = pick.s.replace(re, hole);
        // store the exact answer for this sentence
        state.preps.currentBlank = t;
        state.preps.currentAnswer = t;
        const en = item.en[pick.i] || '';
        return { html:sent, en };
      }
    }
    return null;
  },
  render(item){
    const b = this._blankOneSentence(item);
    $('#ppFeedback').textContent = '';
    $('#ppLevel').textContent = (APP.dsKey==='kapitel')? '' : `Level ${state.preps.level}`;
    if(!b){
      // no sentence contained any surface form â€” fallback: choose again
      $('#ppSentence').innerHTML = '<em class="muted">No cloze found for this item; picking anotherâ€¦</em>';
      $('#ppEnglish').textContent = '';
      return 'repick';
    }
    $('#ppSentence').innerHTML = b.html;
    $('#ppEnglish').textContent = b.en? ('EN: '+b.en): '';
    // focus the hole
    setTimeout(()=>{ const h=$('#ppHole'); if(h){ h.focus(); } }, 0);
  },
  readHole(){ const h=$('#ppHole'); return h ? (h.textContent||'').trim() : ''; },
  check(item){
    const guess = this.readHole();
    const answer = state.preps.currentAnswer || '';
    const ok = guess === answer;
    if(ok){ state.preps.streaks[item.prep]=(state.preps.streaks[item.prep]||0)+1; $('#ppFeedback').innerHTML='<span class="good">Correct!</span>'; }
    else { state.preps.streaks[item.prep]=0; $('#ppFeedback').innerHTML = `<span class="bad">Wrong.</span> Correct: <b>${answer}</b>`; }
    saveAll();
    if(APP.dsKey==='default'){
      const p=this.levelPool();
      if(p.length && p.every(z=>(state.preps.streaks[z.prep]||0)>=APP.masteryTarget) && state.preps.level*APP.wordsPerLevel<state.preps.data.length){
        state.preps.level++; saveAll();
      }
    }
  }
};

/* ===========================================================
   MIX CONTROLLERS
   =========================================================== */

// Default Mix: round-robin among 4 trainers, skips empty pools, prefers unmastered but respects levels
const Mix = {
  order: ['vocab','verbs','adjadv','preps'],
  i: 0,
  nextSection(){
    for(let k=0;k<4;k++){
      this.i = (this.i+1) % this.order.length;
      const sec = this.order[this.i];
      if(!Trainers[sec].hasData()) continue;
      const available = Trainers[sec].levelPool().length>0;
      if(!available) continue;
      return sec;
    }
    return 'vocab';
  },
  render(){
    let sec = this.nextSection();
    this.showSection(sec);
    $('#mixInfo').textContent = `â†’ ${sec}`;
  },
  showSection(sec){
    Trainers[sec].next(true);
    mountSection(sec,'mix');
  }
};


// Kapitel Mix: never touches default CSVs; rotates across the 4 pools, always prefers unmastered; no levels.
// When ALL are mastered: show â€œKapitel masteredâ€ splash with Reset.
const KapitelMix = {
  order: ['vocab','verbs','adjadv','preps'],
  i: -1,
  pickSection(){
    // prefer a section that still has unmastered; else any with data
    const avail = this.order.filter(s=>Trainers[s].hasData());
    const unmastered = avail.filter(s=>Trainers[s].hasUnmastered());
    if(!avail.length) return null;
    if(unmastered.length){
      this.i = (this.i+1) % unmastered.length;
      return unmastered[this.i];
    } else {
      this.i = (this.i+1) % avail.length;
      return avail[this.i];
    }
  },
  render(){
    const mount = $('#kmxMount');
    mount.innerHTML='';
    if(this.allMastered()){
      $('#kmxAllDone').classList.remove('hidden');
      mount.innerHTML = `<div class="center" style="min-height:120px"><strong>Kapitel mastered ðŸŽ‰</strong></div>`;
      return;
    } else {
      $('#kmxAllDone').classList.add('hidden');
    }
    const sec = this.pickSection();
    if(!sec){ mount.innerHTML='<p class="muted">No Kapitel data loaded.</p>'; return; }
    Trainers[sec].next(true);
    mountSection(sec,'kapitel');
  },

  allMastered(){
    return ['vocab','verbs','adjadv','preps'].every(s=> !Trainers[s].hasData() || !Trainers[s].hasUnmastered());
  }
};

/* ===========================================================
   TRAINER BRIDGE
   =========================================================== */
const Trainers = {
  vocab: {
    async load(){ await Vocab.load(); },
    hasData:()=>Vocab.hasData(),
    hasUnmastered:()=>Vocab.hasUnmastered(),
    levelPool:()=>Vocab.levelPool(),
    next(internal=false){ const x=Vocab.pick(); if(!x) return; Vocab.render(x); this._cur=x; if(!internal) setMode('vocab'); },
    check(){ Vocab.check(this._cur); }
  },
  verbs: {
    async load(){ await Verbs.load(); },
    hasData:()=>Verbs.hasData(),
    hasUnmastered:()=>Verbs.hasUnmastered(),
    levelPool:()=>Verbs.levelPool(),
    next(internal=false){ const x=Verbs.pick(); if(!x) return; Verbs.render(x); this._cur=x; if(!internal) setMode('verbs'); },
    check(){ Verbs.check(this._cur); }
  },
  adjadv: {
    async load(){ await AdjAdv.load(); },
    hasData:()=>AdjAdv.hasData(),
    hasUnmastered:()=>AdjAdv.hasUnmastered(),
    levelPool:()=>AdjAdv.levelPool(),
    next(internal=false){ const x=AdjAdv.pick(); if(!x) return; AdjAdv.render(x); this._cur=x; if(!internal) setMode('adjadv'); },
    check(){ AdjAdv.check(this._cur); }
  },
  preps: {
    async load(){ await Preps.load(); },
    hasData:()=>Preps.hasData(),
    hasUnmastered:()=>Preps.hasUnmastered(),
    levelPool:()=>Preps.levelPool(),
    next(internal=false){ 
      let tries=0; let x=null; 
      do{ x=Preps.pick(); tries++; if(!x) break; const r=Preps.render(x); if(r!=='repick') break; } while(tries<5);
      this._cur=x; if(!internal) setMode('preps'); 
    },
    check(){ Preps.check(this._cur); }
  }
};

/* ===========================================================
   UI WIRING
   =========================================================== */

function renderMode(){
  // show only the chosen section
  ['#vocab','#verbs','#adjadv','#preps','#mix','#kapitelMix'].forEach(hide);
  const m = APP.mode;
  if(m==='mix'){ show('#mix'); Mix.render(); }
  else if(m==='kapitelMix'){ show('#kapitelMix'); KapitelMix.render(); }
  else { show('#'+m); }
  $all('.mode-btn').forEach(b=> b.classList.toggle('active', b.dataset.mode===m));
  updateHUD();
}

async function loadAll(){
  // load data fresh according to dataset
  loadAllProgress();
  await Trainers.vocab.load().catch(()=>{});
  await Trainers.verbs.load().catch(()=>{});
  await Trainers.adjadv.load().catch(()=>{});
  await Trainers.preps.load().catch(()=>{});
  dsUI.update();
  updateHUD();
}

function attachEvents(){
  // modes
  $all('.mode-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const m=b.dataset.mode;
      if(m==='kapitelMix' && APP.dsKey!=='kapitel') return;
      setMode(m);
      if(m!=='mix' && m!=='kapitelMix') Trainers[m].next(true); // show fresh
    });
  });

  // dataset selector
  $('#datasetSel').addEventListener('change', async (e)=>{
    const v=e.target.value;
    if(v==='default'){ APP.dsKey='default'; }
    else if(v==='kapitel'){ if(!localStorage.getItem('kapitel_current_v1')) { e.target.value='default'; return; } APP.dsKey='kapitel'; }
    dsUI.update();
    await loadAll();
    if(APP.dsKey==='kapitel' && APP.mode==='mix') setMode('kapitelMix');
    renderMode();
  });

  // Load Kapitel button
  $('#btnLoadKapitel').addEventListener('click', ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.zip';
    inp.onchange=async (ev)=>{ const f=ev.target.files?.[0]; if(!f) return; try{ await handleKapitelZip(f); Trainers.vocab.next(true); setMode('kapitelMix'); }catch(e){ alert(e?.message||String(e)); } };
    inp.click();
  });

  // Vocab
  $all('.article-bar .article-btn').forEach(b=>{
    b.addEventListener('click', ()=>{ state.vocab.article=b.dataset.a; $all('.article-bar .article-btn').forEach(x=>x.classList.toggle('active', x===b)); $('#vocabDe').focus(); });
  });
  $('#vocabCheck').addEventListener('click', ()=>Trainers.vocab.check());
  $('#vocabNext').addEventListener('click', ()=>Trainers.vocab.next());
  $('#vocabReset').addEventListener('click', ()=>{ if(confirm('Reset vocab progress?')){ state.vocab.level=1; state.vocab.streaks={}; saveAll(); Trainers.vocab.next(true); renderMode(); } });
  $('#vocabShowEn').addEventListener('change', (e)=>{ state.vocab.showEn=e.target.checked; saveAll(); renderMode(); });

  // Verbs toggles
  $all('[data-aux]').forEach(b=>b.addEventListener('click', ()=>{ $all('[data-aux]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $('#vPast').focus(); }));
  $all('[data-case]').forEach(b=>b.addEventListener('click', ()=>{ $all('[data-case]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $('#vPrep').focus(); }));
  $all('[data-refl]').forEach(b=>b.addEventListener('click', ()=>{ $all('[data-refl]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $('#vInf').focus(); }));
  $('#verbsCheck').addEventListener('click', ()=>Trainers.verbs.check());
  $('#verbsNext').addEventListener('click', ()=>Trainers.verbs.next());
  $('#verbsReset').addEventListener('click', ()=>{ if(confirm('Reset verbs progress?')){ state.verbs.level=1; state.verbs.streaks={}; saveAll(); Trainers.verbs.next(true); renderMode(); } });

  // Adj/Adv
  $('#aaCheck').addEventListener('click', ()=>Trainers.adjadv.check());
  $('#aaNext').addEventListener('click', ()=>Trainers.adjadv.next());
  $('#aaReset').addEventListener('click', ()=>{ if(confirm('Reset adj/adv progress?')){ state.adjadv.level=1; state.adjadv.streaks={}; saveAll(); Trainers.adjadv.next(true); renderMode(); } });

  // Preps
  $('#ppCheck').addEventListener('click', ()=>Trainers.preps.check());
  $('#ppNext').addEventListener('click', ()=>Trainers.preps.next());
  $('#ppReset').addEventListener('click', ()=>{ if(confirm('Reset preps progress?')){ state.preps.level=1; state.preps.streaks={}; saveAll(); Trainers.preps.next(true); renderMode(); } });

  // Mix
  $('#mix').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); Mix.render(); } });

  // Kapitel Mix
  $('#kmxNext').addEventListener('click', ()=>KapitelMix.render());
  $('#kmxReset').addEventListener('click', ()=>{ if(confirm('Reset Kapitel-only progress?')){ 
    // wipe only Kapitel progress keys
    localStorage.removeItem('vocabProgress::kapitel');
    localStorage.removeItem('verbsProgress::kapitel');
    localStorage.removeItem('adjadvProgress::kapitel');
    localStorage.removeItem('prepsProgress::kapitel');
    state.vocab.streaks={}; state.verbs.streaks={}; state.adjadv.streaks={}; state.preps.streaks={};
    KapitelMix.render();
  }});

  // Sidebar toggle
  const side = $('#side'), mask = $('#sideMask');
  const openSide = ()=>{ document.body.classList.add('side-open'); };
  const closeSide = ()=>{ document.body.classList.remove('side-open'); };
  $('#btnSide').addEventListener('click', openSide);
  $('#btnSideClose').addEventListener('click', closeSide);
  mask.addEventListener('click', closeSide);


  // Sync
  $('#btnSync').addEventListener('click', ()=> { $('#syncModal').style.display='flex'; $('#syncUser').value = localStorage.getItem('syncUser')||''; });
  $('#syncCancel').addEventListener('click', ()=>{ $('#syncModal').style.display='none'; });
  $('#syncEnable').addEventListener('click', async ()=>{
    const u = ($('#syncUser').value||'').trim();
    if(!u) return alert('Enter a username');
    try{
      const remote = await cloudPull(u);
      if(remote){
        if(confirm('Cloud data found. Load it now? (Overwrites local)')){
          applyCloud(remote);
        }
      }
      localStorage.setItem('syncUser', u);
      $('#syncStatus').textContent = 'Sync: '+u;
      $('#syncModal').style.display='none';
      scheduleSyncSoon();
    }catch(e){ alert('Sync error'); }
  });

  // Debug HUD
  $('#btnDebug').addEventListener('click', ()=>{ const h=$('#debugHUD'); h.style.display = (h.style.display==='none'||!h.style.display)?'block':'none'; });
  $('#dbgDump').addEventListener('click', ()=>{ console.log({APP,state}); alert('Dumped to console.'); });

  // GLOBAL ENTER ENGINE
  let enterArmed = false;

  function modeFields(mode){
    // ordered focus list per trainer
    if(mode==='vocab')   return ['#vocabDe','#vocabPl']; // article is buttons; after click we keep focus on #vocabDe
    if(mode==='verbs')   return ['#vInf','#pIch','#pDu','#pEr','#pIhr','#vPast','#vPart','#vPrep']; // aux/case/refl are buttons
    if(mode==='adjadv')  return ['#aaDe'];
    if(mode==='preps')   return ['#ppHole']; // contenteditable in sentence
    // In Mix/Kapitel Mix we mounted the real section, so APP.mode may be 'mix' or 'kapitelMix';
    // detect the currently mounted section by checking which trainer element is visible:
    if(mode==='mix' || mode==='kapitelMix'){
      if(!mounted) return [];
      const sec = mounted.sec;
      return modeFields(sec);
    }
    return [];
  }

  function sectionCheck(mode){
    const m = (mode==='mix'||mode==='kapitelMix') && mounted ? mounted.sec : mode;
    if(!m) return;
    Trainers[m]?.check && Trainers[m].check();
  }
  function sectionNext(mode){
    const m = (mode==='mix'||mode==='kapitelMix') && mounted ? mounted.sec : mode;
    if(!m) return;
    Trainers[m]?.next && Trainers[m].next(true);
    // If weâ€™re in Mix/Kapitel Mix, rotate controller
    if(mode==='mix') Mix.render();
    if(mode==='kapitelMix') KapitelMix.render();
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    // Identify active fields
    const fields = modeFields(APP.mode).map(s=>document.querySelector(s)).filter(Boolean);
    if(!fields.length) return;

    const active = document.activeElement;
    const idx = fields.indexOf(active);

    // Special case: if preps hole isn't focused, push focus first
    if(APP.mode==='preps' || APP.mode==='kapitelMix'){
      const hole = document.querySelector('#ppHole');
      if(hole && fields[0]===hole && active!==hole){
        e.preventDefault(); hole.focus(); return;
      }
    }

    if(idx>-1 && idx < fields.length-1){
      // go to next field
      e.preventDefault();
      fields[idx+1].focus();
      enterArmed = false;
      return;
    }

    // last field or not in list â†’ run check/next logic
    e.preventDefault();
    if(!enterArmed){
      enterArmed = true;
      sectionCheck(APP.mode);
      // Keep focus on the last field so user can see result; pressing Enter again advances.
      const last = fields[fields.length-1]; if(last) last.focus();
    } else {
      enterArmed = false;
      sectionNext(APP.mode);
      // Focus first field of the new item
      setTimeout(()=>{
        const nf = modeFields(APP.mode).map(s=>document.querySelector(s)).filter(Boolean)[0];
        nf && nf.focus();
      },0);
    }
  });


/* ===========================================================
   LOAD SAMPLE DATA (for quick testing)
   =========================================================== */

// FIND â†’ PASTE BELOW: SAMPLE_CSVS
const SAMPLE_VOCAB = [
  "english,article,german,plural,example1,example2,example3",
  "book,das,Das Buch,BÃ¼cher,Ich lese ein Buch.,Das Buch ist interessant.,Sie kaufen viele BÃ¼cher.",
  "cat,die,Die Katze,Katzen,Die Katze schlÃ¤ft.,Ich mag Katzen.,Die Katzen sind sÃ¼ÃŸ.",
  "man,der,Der Mann,MÃ¤nner,Der Mann arbeitet.,Ich sehe den Mann.,Viele MÃ¤nner sind hier."
].join("\n");


const SAMPLE_VERBS = [
  "id,lemma,english,aux,ich,du,er,wir,ihr,sie,partizip,past,preps,case,reflexive",
  "gehen,gehen,to go,sein,gehe,gehst,geht,gehen,geht,gehen,gegangen,ging,,-,false",
  "sprechen,sprechen,to speak,haben,spreche,sprichst,spricht,sprechen,sprecht,sprechen,gesprochen,sprach,Ã¼ber,akk,false",
  "sich-waschen,waschen,to wash,haben,wasche,waeschst,waescht,waschen,wascht,waschen,gewaschen,wusch,,inf,true"
].join("\n");


const SAMPLE_AA = [
  "english,german,example",
  "beautiful,schÃ¶n,Das ist ein schÃ¶nes Bild.",
  "dangerous,gefÃ¤hrlich,Das ist eine gefÃ¤hrliche Kreuzung.",
  "often,hÃ¤ufig,Ich fahre hÃ¤ufig mit dem Rad."
].join("\n");


const SAMPLE_PREPS = [
  "prep,forms,de1,de2,de3,de4,de5,de6,de7,de8,de9,de10,en1,en2,en3,en4,en5,en6,en7,en8,en9,en10",
  "in,in;im;ins,Ich bin im BÃ¼ro.,Wir gehen ins Kino.,Er wohnt in Berlin.,,,,,,I'm at the office.,We're going to the cinema.,He lives in Berlin.,,,,,,,",
  "auf,auf,Das Buch liegt auf dem Tisch.,Wir gehen auf den Markt.,Er ist auf der BÃ¼hne.,,,,,,The book is on the table.,We are going to the market.,He is on the stage.,,,,,,,"
].join("\n");

/* ===========================================================
   APP INIT
   =========================================================== */
async function loadDefaultIfMissing(name, sample){
  try{
	  await datasetRead(name);
	}catch{
	  if(APP.dsKey==='default'){
		if(!APP._inline){ APP._inline = {}; }
		APP._inline[name] = sample; // datasetRead will now read inline safely
	  }
	}
}

async function boot(){
  // restore last mode
  APP.mode = localStorage.getItem('mode') || 'vocab';

  // inline samples if local files missing
  await loadDefaultIfMissing('vocab.csv', SAMPLE_VOCAB);
  await loadDefaultIfMissing('verbs.csv', SAMPLE_VERBS);
  await loadDefaultIfMissing('adjadv.csv', SAMPLE_AA);
  await loadDefaultIfMissing('prepositions.csv', SAMPLE_PREPS);

  await loadAll();
  attachEvents();
  Trainers.vocab.next(true);
  renderMode();

  // set sync badge
  $('#syncStatus').textContent = localStorage.getItem('syncUser')? 'Sync: '+localStorage.getItem('syncUser') : 'Sync: Off';
}

document.addEventListener('DOMContentLoaded', boot);

/* ===========================================================
   Tiny extras (copy text markers)
   =========================================================== */
// FIND â†’ PASTE BELOW: UI_COPY
// (Leave empty â€” reserved for quick copy changes without searching the whole file.)

</script>
</body>
</html>
